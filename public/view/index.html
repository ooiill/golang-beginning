<html lang="zh-CN">
<head>
    <title>全员-聊天室</title>
    <script src="../js/jquery.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
</head>

<style>
    div.container {
        margin: 20px auto;
        width: 600px;
        text-align: center;
        font-family: Monaco, -apple-system, BlinkMacSystemFont, Segoe UI, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Helvetica Neue, Helvetica, Arial, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol;
    }

    div#chat {
        text-align: left;
        background: #fbfbfb;
        width: 560px;
        height: 350px;
        padding: 10px 20px;
        font-size: 14px;
        margin-bottom: 20px;
        overflow: scroll;
    }

    div#chat > p > b {
        font-weight: normal;
        border-radius: 4px;
        padding: 2px 4px;
        color: #a8a8a9;
    }

    div#chat > p.online, div#chat > p.offline {
        text-align: center;
    }

    div#chat > p.online > b {
        border: 1px solid #e6e6e6;
    }

    div#chat > p.offline > b {
        border: 1px solid #ffcece;
        color: #ffbdbd;
    }

    input#text {
        width: 100%;
        height: 44px;
        border-radius: 0;
        border: 1px solid gray;
        text-indent: 5px;
        font-size: 14px;
    }

    @media screen and (max-width: 750px) {
        div.container {
            width: 100%;
        }

        div#chat {
            width: 96%;
            padding: 10px 2%;
        }
    }
</style>

<body>
<div class="container">
    <h3>全员-聊天室 (<span id="counter">0</span>) <sup id="name"></sup></h3>
    <div id="chat"></div>
    <input placeholder="说点什么呢,按回车发送" id="text" type="text" autofocus/>
</div>

<script>
    let url = "ws://" + window.location.host + "/ws/behavior";
    let ws = new WebSocket(url);
    let getName = function () {
        let name = prompt("请输入你的昵称");
        if (name == null || name.length === 0) {
            return getName();
        }
        return name;
    }
    let name = getName()
    $("sup#name").html(name);
    let token, user_id;

    // 创建成功
    ws.onopen = function () {
        console.log("成功连接服务器。");
        ws.send(JSON.stringify({
            Behavior: "register",
            Arguments: {
                nickname: name
            }
        }))
    }
    // 关闭
    ws.onclose = function (e) {
        console.log("收到关闭请求，成功断开连接。", e);
    }
    // 触发错误
    ws.onerror = function (e) {
        console.log("连接/接收/发送出现错误。", e);
    }

    let chatDiv = $("div#chat")
    ws.onmessage = function (msg) {
        let response = eval(`(${msg.data})`)
        console.log("收到消息", response)
        if (response.Behavior === "register") {
            [token, user_id] = [response.Arguments.token, response.Arguments.user_id];
        } else if (response.Behavior === "online") {
            chatDiv.append(`<p class="online"><b> ${response.Arguments.nickname} 上线了</b></p>`)
            $("span#counter").html(response.Arguments.counter);
        } else if (response.Behavior === "offline") {
            chatDiv.append(`<p class="offline"><b> ${response.Arguments.nickname} 下线了</b></p>`)
            $("span#counter").html(response.Arguments.counter);
        } else if (response.Behavior === "chat") {
            chatDiv.append(`<p><b>${response.Arguments.time}</b> ${response.Arguments.from}: ${response.Arguments.message}</p>`)
        }
        chatDiv.animate({scrollTop: chatDiv.prop("scrollHeight")}, 200);
    };

    let text = $("input#text")
    text.on("keydown", function (e) {
        if (e.keyCode === 13 && text.val() !== "") {
            ws.send(JSON.stringify({
                Authorization: token,
                Behavior: "chat",
                Arguments: {
                    message: text.val()
                },
                Time: Math.floor((new Date()).getTime() / 1000)
            }))
            text.val("");
        }
    })
</script>
</body>
</html>